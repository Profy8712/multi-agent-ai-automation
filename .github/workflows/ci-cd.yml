name: CI/CD - Multi-Agent Gemini Service

on:
  push:
    branches:
      - main
      - feature/**
  pull_request:
    branches:
      - main

jobs:
  lint-and-test:
    name: Lint & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Check Python syntax (compile all modules)
        run: |
          python -m compileall .

      - name: Run tests (if tests/ exists)
        run: |
          if [ -d "tests" ]; then
            echo "Running pytest..."
            pytest
          else
            echo "No tests directory found, skipping pytest."
          fi

  build-and-push-docker:
    name: Build & (optional) push Docker image
    runs-on: ubuntu-latest
    needs: lint-and-test
    # Only on push to main
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    env:
      IMAGE_NAME: multi-agent-gemini

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker registry credentials
        if: env.REGISTRY_ENABLED != 'false'
        env:
          REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
          REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
          REGISTRY_SERVER: ${{ secrets.REGISTRY_SERVER }}
        run: |
          if [ -z "$REGISTRY_USERNAME" ] || [ -z "$REGISTRY_PASSWORD" ] || [ -z "$REGISTRY_SERVER" ]; then
            echo "Registry secrets not set. Skipping docker login and push."
            echo "REGISTRY_ENABLED=false" >> $GITHUB_ENV
          else
            echo "Logging into Docker registry: $REGISTRY_SERVER"
            echo "$REGISTRY_PASSWORD" | docker login "$REGISTRY_SERVER" -u "$REGISTRY_USERNAME" --password-stdin
          fi

      - name: Build Docker image
        run: |
          docker build -t $IMAGE_NAME:latest .

      - name: Tag and push image to registry (optional)
        if: env.REGISTRY_ENABLED != 'false'
        env:
          REGISTRY_SERVER: ${{ secrets.REGISTRY_SERVER }}
          REGISTRY_REPOSITORY: ${{ secrets.REGISTRY_REPOSITORY }}
        run: |
          # Default: use GitHub owner/repo name if custom repo is not set
          if [ -z "$REGISTRY_REPOSITORY" ]; then
            REPO="$(echo "${GITHUB_REPOSITORY}" | tr '[:upper:]' '[:lower:]')"
          else
            REPO="$REGISTRY_REPOSITORY"
          fi

          FULL_IMAGE_NAME="$REGISTRY_SERVER/$REPO:$GITHUB_SHA"

          echo "Tagging image as $FULL_IMAGE_NAME"
          docker tag $IMAGE_NAME:latest "$FULL_IMAGE_NAME"

          echo "Pushing image..."
          docker push "$FULL_IMAGE_NAME"
